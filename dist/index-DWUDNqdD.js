import{b as G,q as ee,d as L,j as te,p as K,g as B,k as le,I as Q,i as X,U as ne,n as re}from"./index-DVzO2118.js";import{o as r,b as oe,c as se,s as n,n as m,a as E,_ as ue,l as ce,r as z,e as de}from"./main-B2AV-kr0.js";function $(e){var t,o;return(o=(t=e?.providerOptions)==null?void 0:t.openaiCompatible)!=null?o:{}}function pe(e){const t=[];for(const{role:o,content:a,...f}of e){const d=$({...f});switch(o){case"system":{t.push({role:"system",content:a,...d});break}case"user":{if(a.length===1&&a[0].type==="text"){t.push({role:"user",content:a[0].text,...$(a[0])});break}t.push({role:"user",content:a.map(s=>{const p=$(s);switch(s.type){case"text":return{type:"text",text:s.text,...p};case"file":if(s.mediaType.startsWith("image/")){const i=s.mediaType==="image/*"?"image/jpeg":s.mediaType;return{type:"image_url",image_url:{url:s.data instanceof URL?s.data.toString():`data:${i};base64,${re(s.data)}`},...p}}else throw new ne({functionality:`file part media type ${s.mediaType}`})}}),...d});break}case"assistant":{let s="";const p=[];for(const i of a){const u=$(i);switch(i.type){case"text":{s+=i.text;break}case"tool-call":{p.push({id:i.toolCallId,type:"function",function:{name:i.toolName,arguments:JSON.stringify(i.input)},...u});break}}}t.push({role:"assistant",content:s,tool_calls:p.length>0?p:void 0,...d});break}case"tool":{for(const s of a){const p=s.output;let i;switch(p.type){case"text":case"error-text":i=p.value;break;case"content":case"json":case"error-json":i=JSON.stringify(p.value);break}const u=$(s);t.push({role:"tool",tool_call_id:s.toolCallId,content:i,...u})}break}default:{const s=o;throw new Error(`Unsupported role: ${s}`)}}}return t}function Y({id:e,model:t,created:o}){return{id:e??void 0,modelId:t??void 0,timestamp:o!=null?new Date(o*1e3):void 0}}function Z(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var W=r({user:n().optional(),reasoningEffort:n().optional(),textVerbosity:n().optional()}),he=r({error:r({message:n(),type:n().nullish(),param:se().nullish(),code:oe([n(),m()]).nullish()})}),ie={errorSchema:he,errorToMessage:e=>e.error.message};function me({tools:e,toolChoice:t}){e=e?.length?e:void 0;const o=[];if(e==null)return{tools:void 0,toolChoice:void 0,toolWarnings:o};const a=[];for(const d of e)d.type==="provider-defined"?o.push({type:"unsupported-tool",tool:d}):a.push({type:"function",function:{name:d.name,description:d.description,parameters:d.inputSchema}});if(t==null)return{tools:a,toolChoice:void 0,toolWarnings:o};const f=t.type;switch(f){case"auto":case"none":case"required":return{tools:a,toolChoice:f,toolWarnings:o};case"tool":return{tools:a,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:o};default:{const d=f;throw new ne({functionality:`tool choice type: ${d}`})}}}var Te=class{constructor(e,t){this.specificationVersion="v2";var o,a;this.modelId=e,this.config=t;const f=(o=t.errorStructure)!=null?o:ie;this.chunkSchema=ge(f.errorSchema),this.failedResponseHandler=ee(f),this.supportsStructuredOutputs=(a=t.supportsStructuredOutputs)!=null?a:!1}get provider(){return this.config.provider}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get supportedUrls(){var e,t,o;return(o=(t=(e=this.config).supportedUrls)==null?void 0:t.call(e))!=null?o:{}}async getArgs({prompt:e,maxOutputTokens:t,temperature:o,topP:a,topK:f,frequencyPenalty:d,presencePenalty:s,providerOptions:p,stopSequences:i,responseFormat:u,seed:c,toolChoice:j,tools:C}){var T,x,h,l;const k=[],b=Object.assign((T=await K({provider:"openai-compatible",providerOptions:p,schema:W}))!=null?T:{},(x=await K({provider:this.providerOptionsName,providerOptions:p,schema:W}))!=null?x:{});f!=null&&k.push({type:"unsupported-setting",setting:"topK"}),u?.type==="json"&&u.schema!=null&&!this.supportsStructuredOutputs&&k.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});const{tools:R,toolChoice:D,toolWarnings:N}=me({tools:C,toolChoice:j});return{args:{model:this.modelId,user:b.user,max_tokens:t,temperature:o,top_p:a,frequency_penalty:d,presence_penalty:s,response_format:u?.type==="json"?this.supportsStructuredOutputs===!0&&u.schema!=null?{type:"json_schema",json_schema:{schema:u.schema,name:(h=u.name)!=null?h:"response",description:u.description}}:{type:"json_object"}:void 0,stop:i,seed:c,...Object.fromEntries(Object.entries((l=p?.[this.providerOptionsName])!=null?l:{}).filter(([g])=>!Object.keys(W.shape).includes(g))),reasoning_effort:b.reasoningEffort,verbosity:b.textVerbosity,messages:pe(e),tools:R,tool_choice:D},warnings:[...k,...N]}}async doGenerate(e){var t,o,a,f,d,s,p,i,u,c,j,C,T,x,h,l,k;const{args:b,warnings:R}=await this.getArgs({...e}),D=JSON.stringify(b),{responseHeaders:N,value:g,rawValue:O}=await G({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:L(this.config.headers(),e.headers),body:b,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:te(fe),abortSignal:e.abortSignal,fetch:this.config.fetch}),I=g.choices[0],H=[],A=I.message.content;A!=null&&A.length>0&&H.push({type:"text",text:A});const M=(t=I.message.reasoning_content)!=null?t:I.message.reasoning;if(M!=null&&M.length>0&&H.push({type:"reasoning",text:M}),I.message.tool_calls!=null)for(const q of I.message.tool_calls)H.push({type:"tool-call",toolCallId:(o=q.id)!=null?o:B(),toolName:q.function.name,input:q.function.arguments});const U={[this.providerOptionsName]:{},...await((f=(a=this.config.metadataExtractor)==null?void 0:a.extractMetadata)==null?void 0:f.call(a,{parsedBody:O}))},S=(d=g.usage)==null?void 0:d.completion_tokens_details;return S?.accepted_prediction_tokens!=null&&(U[this.providerOptionsName].acceptedPredictionTokens=S?.accepted_prediction_tokens),S?.rejected_prediction_tokens!=null&&(U[this.providerOptionsName].rejectedPredictionTokens=S?.rejected_prediction_tokens),{content:H,finishReason:Z(I.finish_reason),usage:{inputTokens:(p=(s=g.usage)==null?void 0:s.prompt_tokens)!=null?p:void 0,outputTokens:(u=(i=g.usage)==null?void 0:i.completion_tokens)!=null?u:void 0,totalTokens:(j=(c=g.usage)==null?void 0:c.total_tokens)!=null?j:void 0,reasoningTokens:(x=(T=(C=g.usage)==null?void 0:C.completion_tokens_details)==null?void 0:T.reasoning_tokens)!=null?x:void 0,cachedInputTokens:(k=(l=(h=g.usage)==null?void 0:h.prompt_tokens_details)==null?void 0:l.cached_tokens)!=null?k:void 0},providerMetadata:U,request:{body:D},response:{...Y(g),headers:N,body:O},warnings:R}}async doStream(e){var t;const{args:o,warnings:a}=await this.getArgs({...e}),f={...o,stream:!0,stream_options:this.config.includeUsage?{include_usage:!0}:void 0},d=(t=this.config.metadataExtractor)==null?void 0:t.createStreamExtractor(),{responseHeaders:s,value:p}=await G({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:L(this.config.headers(),e.headers),body:f,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:le(this.chunkSchema),abortSignal:e.abortSignal,fetch:this.config.fetch}),i=[];let u="unknown";const c={completionTokens:void 0,completionTokensDetails:{reasoningTokens:void 0,acceptedPredictionTokens:void 0,rejectedPredictionTokens:void 0},promptTokens:void 0,promptTokensDetails:{cachedTokens:void 0},totalTokens:void 0};let j=!0;const C=this.providerOptionsName;let T=!1,x=!1;return{stream:p.pipeThrough(new TransformStream({start(h){h.enqueue({type:"stream-start",warnings:a})},transform(h,l){var k,b,R,D,N,g,O,I,H,A,M,U,S;if(e.includeRawChunks&&l.enqueue({type:"raw",rawValue:h.rawValue}),!h.success){u="error",l.enqueue({type:"error",error:h.error});return}const q=h.value;if(d?.processChunk(h.rawValue),"error"in q){u="error",l.enqueue({type:"error",error:q.error.message});return}if(j&&(j=!1,l.enqueue({type:"response-metadata",...Y(q)})),q.usage!=null){const{prompt_tokens:_,completion_tokens:P,total_tokens:y,prompt_tokens_details:v,completion_tokens_details:w}=q.usage;c.promptTokens=_??void 0,c.completionTokens=P??void 0,c.totalTokens=y??void 0,w?.reasoning_tokens!=null&&(c.completionTokensDetails.reasoningTokens=w?.reasoning_tokens),w?.accepted_prediction_tokens!=null&&(c.completionTokensDetails.acceptedPredictionTokens=w?.accepted_prediction_tokens),w?.rejected_prediction_tokens!=null&&(c.completionTokensDetails.rejectedPredictionTokens=w?.rejected_prediction_tokens),v?.cached_tokens!=null&&(c.promptTokensDetails.cachedTokens=v?.cached_tokens)}const V=q.choices[0];if(V?.finish_reason!=null&&(u=Z(V.finish_reason)),V?.delta==null)return;const J=V.delta,F=(k=J.reasoning_content)!=null?k:J.reasoning;if(F&&(T||(l.enqueue({type:"reasoning-start",id:"reasoning-0"}),T=!0),l.enqueue({type:"reasoning-delta",id:"reasoning-0",delta:F})),J.content&&(x||(l.enqueue({type:"text-start",id:"txt-0"}),x=!0),l.enqueue({type:"text-delta",id:"txt-0",delta:J.content})),J.tool_calls!=null)for(const _ of J.tool_calls){const P=_.index;if(i[P]==null){if(_.id==null)throw new Q({data:_,message:"Expected 'id' to be a string."});if(((b=_.function)==null?void 0:b.name)==null)throw new Q({data:_,message:"Expected 'function.name' to be a string."});l.enqueue({type:"tool-input-start",id:_.id,toolName:_.function.name}),i[P]={id:_.id,type:"function",function:{name:_.function.name,arguments:(R=_.function.arguments)!=null?R:""},hasFinished:!1};const v=i[P];((D=v.function)==null?void 0:D.name)!=null&&((N=v.function)==null?void 0:N.arguments)!=null&&(v.function.arguments.length>0&&l.enqueue({type:"tool-input-delta",id:v.id,delta:v.function.arguments}),X(v.function.arguments)&&(l.enqueue({type:"tool-input-end",id:v.id}),l.enqueue({type:"tool-call",toolCallId:(g=v.id)!=null?g:B(),toolName:v.function.name,input:v.function.arguments}),v.hasFinished=!0));continue}const y=i[P];y.hasFinished||(((O=_.function)==null?void 0:O.arguments)!=null&&(y.function.arguments+=(H=(I=_.function)==null?void 0:I.arguments)!=null?H:""),l.enqueue({type:"tool-input-delta",id:y.id,delta:(A=_.function.arguments)!=null?A:""}),((M=y.function)==null?void 0:M.name)!=null&&((U=y.function)==null?void 0:U.arguments)!=null&&X(y.function.arguments)&&(l.enqueue({type:"tool-input-end",id:y.id}),l.enqueue({type:"tool-call",toolCallId:(S=y.id)!=null?S:B(),toolName:y.function.name,input:y.function.arguments}),y.hasFinished=!0))}},flush(h){var l,k,b,R,D,N;T&&h.enqueue({type:"reasoning-end",id:"reasoning-0"}),x&&h.enqueue({type:"text-end",id:"txt-0"});for(const O of i.filter(I=>!I.hasFinished))h.enqueue({type:"tool-input-end",id:O.id}),h.enqueue({type:"tool-call",toolCallId:(l=O.id)!=null?l:B(),toolName:O.function.name,input:O.function.arguments});const g={[C]:{},...d?.buildMetadata()};c.completionTokensDetails.acceptedPredictionTokens!=null&&(g[C].acceptedPredictionTokens=c.completionTokensDetails.acceptedPredictionTokens),c.completionTokensDetails.rejectedPredictionTokens!=null&&(g[C].rejectedPredictionTokens=c.completionTokensDetails.rejectedPredictionTokens),h.enqueue({type:"finish",finishReason:u,usage:{inputTokens:(k=c.promptTokens)!=null?k:void 0,outputTokens:(b=c.completionTokens)!=null?b:void 0,totalTokens:(R=c.totalTokens)!=null?R:void 0,reasoningTokens:(D=c.completionTokensDetails.reasoningTokens)!=null?D:void 0,cachedInputTokens:(N=c.promptTokensDetails.cachedTokens)!=null?N:void 0},providerMetadata:g})}})),request:{body:f},response:{headers:s}}}},ae=r({prompt_tokens:m().nullish(),completion_tokens:m().nullish(),total_tokens:m().nullish(),prompt_tokens_details:r({cached_tokens:m().nullish()}).nullish(),completion_tokens_details:r({reasoning_tokens:m().nullish(),accepted_prediction_tokens:m().nullish(),rejected_prediction_tokens:m().nullish()}).nullish()}).nullish(),fe=r({id:n().nullish(),created:m().nullish(),model:n().nullish(),choices:E(r({message:r({role:ce("assistant").nullish(),content:n().nullish(),reasoning_content:n().nullish(),reasoning:n().nullish(),tool_calls:E(r({id:n().nullish(),function:r({name:n(),arguments:n()})})).nullish()}),finish_reason:n().nullish()})),usage:ae}),ge=e=>oe([r({id:n().nullish(),created:m().nullish(),model:n().nullish(),choices:E(r({delta:r({role:ue(["assistant"]).nullish(),content:n().nullish(),reasoning_content:n().nullish(),reasoning:n().nullish(),tool_calls:E(r({index:m(),id:n().nullish(),function:r({name:n().nullish(),arguments:n().nullish()})})).nullish()}).nullish(),finish_reason:n().nullish()})),usage:ae}),e]);r({echo:de().optional(),logitBias:z(n(),m()).optional(),suffix:n().optional(),user:n().optional()});var _e=r({prompt_tokens:m(),completion_tokens:m(),total_tokens:m()});r({id:n().nullish(),created:m().nullish(),model:n().nullish(),choices:E(r({text:n(),finish_reason:n()})),usage:_e.nullish()});r({dimensions:m().optional(),user:n().optional()});r({data:E(r({embedding:E(m())})),usage:r({prompt_tokens:m()}).nullish(),providerMetadata:z(n(),z(n(),se())).optional()});var be=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxImagesPerCall=10}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:o,aspectRatio:a,seed:f,providerOptions:d,headers:s,abortSignal:p}){var i,u,c,j,C;const T=[];a!=null&&T.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),f!=null&&T.push({type:"unsupported-setting",setting:"seed"});const x=(c=(u=(i=this.config._internal)==null?void 0:i.currentDate)==null?void 0:u.call(i))!=null?c:new Date,{value:h,responseHeaders:l}=await G({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:L(this.config.headers(),s),body:{model:this.modelId,prompt:e,n:t,size:o,...(j=d.openai)!=null?j:{},response_format:"b64_json"},failedResponseHandler:ee((C=this.config.errorStructure)!=null?C:ie),successfulResponseHandler:te(ve),abortSignal:p,fetch:this.config.fetch});return{images:h.data.map(k=>k.b64_json),warnings:T,response:{timestamp:x,modelId:this.modelId,headers:l}}}},ve=r({data:E(r({b64_json:n()}))});export{be as O,Te as a};
//# sourceMappingURL=index-DWUDNqdD.js.map
